<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadcopter Altitude Hold Strategy Analysis</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .diagram { background: #e8f4f8; padding: 20px; border-radius: 5px; border: 1px solid #bdc3c7; margin: 20px 0; text-align: center; font-family: 'Courier New', monospace; white-space: pre-wrap; overflow-x: auto; }
        .sensor-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .sensor-table th, .sensor-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .sensor-table th { background-color: #3498db; color: white; }
        .strategy-box { background-color: #eafaf1; border-left: 5px solid #2ecc71; padding: 15px; margin: 20px 0; }
        .warning-box { background-color: #fdedec; border-left: 5px solid #e74c3c; padding: 15px; margin: 20px 0; }
        code { background-color: #eee; padding: 2px 5px; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸš€ Quadcopter Altitude Hold Strategy</h1>
    <p><strong>Date:</strong> 2026-01-13<br>
    <strong>System:</strong> ESP32 Custom Flight Controller<br>
    <strong>Sensors:</strong> MPU6050 (IMU), BMP280 (Barometer), VL53L0X (Laser)</p>

    <h2>1. System Architecture</h2>
    <p>The system now integrates three key sensors to achieve stable flight and altitude hold.</p>
    
    <table class="sensor-table">
        <tr>
            <th>Sensor</th>
            <th>Range</th>
            <th>Precision</th>
            <th>Role</th>
        </tr>
        <tr>
            <td><strong>MPU6050 (IMU)</strong></td>
            <td>N/A</td>
            <td>High</td>
            <td><strong>Attitude Stabilization</strong> (Roll/Pitch/Yaw)</td>
        </tr>
        <tr>
            <td><strong>VL53L0X (Laser)</strong></td>
            <td>0 - 2.0 meters</td>
            <td>Â±1 mm to Â±10 mm</td>
            <td><strong>Precision Hover</strong> (Low Altitude / Landing)</td>
        </tr>
        <tr>
            <td><strong>BMP280 (Baro)</strong></td>
            <td>0 - 2000+ meters</td>
            <td>Â±15 cm (Noise), Â±20 cm (Drift)</td>
            <td><strong>General Altitude</strong> (High Flight)</td>
        </tr>
    </table>

    <h2>2. Sensor Fusion Strategy</h2>
    <p>We cannot rely on a single sensor. The barometer drifts, and the laser is blind above 2 meters. We use a <strong>Hybrid Switching Strategy</strong> with continuous bias correction.</p>

    <div class="diagram">
       ALTITUDE (Meters)
          ^
      3.0 |   [ PHASE 3: PURE BAROMETER ]
          |   (Baro runs relative to last Laser fix)
      2.5 |
      2.0 |-------------------------------------- SWITCH POINT (2.0m)
      1.5 |   [ PHASE 2: TRANSITION ]
          |   (Cross-fade Laser <-> Baro)
      1.0 |
      0.5 |   [ PHASE 1: PURE LASER ]
          |   (Laser is primary. Baro is constantly re-zeroed)
      0.0 +--------------------------------------> TIME
    </div>

    <div class="strategy-box">
        <h3>The "No-Jump" Logic:</h3>
        <ul>
            <li><strong>While < 2m:</strong> The system uses Laser for altitude using a PID controller.</li>
            <li><strong>Background Task:</strong> The system calculates <code>Baro_Offset = Current_Baro_Pressure - Pressure_At_Laser_Height</code>. This ensures the Barometer "learns" the exact pressure at the current laser height.</li>
            <li><strong>Crossing 2m:</strong> When the Laser becomes invalid, the system switches to Barometer. Because the offset was updated milliseconds ago, the Barometer reading <strong>matches the Laser reading perfectly</strong>. No jump occurs.</li>
        </ul>
    </div>

    <h2>3. Control Loop Diagram (The "Strategy")</h2>
    <p>This is how the software will control the motors to hold altitude.</p>

    <div class="diagram">
    USER AUX2 (Switch) ----> [ MODE SELECTOR ] 
                                  |
                                  v
    [ TARGET GENERATOR ] ---> [ ALTITUDE PID CONTROLLER ]
    (e.g., 1.0 meter)             |  (Compensates Gravity)
                                  |
                                  v
                            [ VERTICAL VELOCITY PID ] <---- [ Z-ACCEL ] (Damping)
                                  |
                                  v
    [ THROTTLE STICK ] ---> [ THROTTLE MIXER ] ---------> [ MOTORS ]
    (Ignored in Auto)       (Bass + PID adjustments)
    </div>

    <h2>4. Auto-Hover & Auto-Land</h2>
    <p>We will implement a simple state machine on <strong>Channel 6 (AUX2)</strong>.</p>
    <ul>
        <li><strong>Switch LOW (Manual):</strong> User controls Throttle directly. PID Inactive.</li>
        <li><strong>Switch HIGH (Alt Hold):</strong>
            <ol>
                <li>System captures current height (or sets Target = 1.0m).</li>
                <li>PID Controller takes over Throttle.</li>
                <li><strong>If Height > 1m:</strong> Target decreases slowly (Descent).</li>
                <li><strong>If Height < 1m:</strong> Target increases (Ascent).</li>
                <li><strong>At 1m:</strong> Lock Target. Hover using Laser precision.</li>
            </ol>
        </li>
    </ul>

    <div class="warning-box">
        <h3>CRITICAL SAFETY NOTES</h3>
        <p><strong>1. Horizontal Drift:</strong> The drone observes <strong>Z-Axis Only</strong>. It DOES NOT know if it is drifting sideways. The pilot MUST steer lightly to keep it in place.</p>
        <p><strong>2. Vibration:</strong> The Barometer is sensitive to light and prop wash. The Foam cover is essential. The Laser is sensitive to sunlight (IR interference), but indoor performance is excellent.</p>
    </div>

    <h2>5. Implementation Plan (Next Session)</h2>
    <ol>
        <li><strong>Step 1 (Done):</strong> Restore Flight Firmware + Integreate Baro & Laser Drivers.</li>
        <li><strong>Step 2 (Action):</strong> Flash Firmware & Perform Manual Flight (Blackbox Recording).</li>
        <li><strong>Step 3:</strong> Analyze Logs (Verify Laser data reliability vs Vibration).</li>
        <li><strong>Step 4:</strong> Code the Z-Axis PID Controller.</li>
        <li><strong>Step 5:</strong> Test Alt Hold at low altitude (0.5m).</li>
    </ol>

</div>

</body>
</html>
