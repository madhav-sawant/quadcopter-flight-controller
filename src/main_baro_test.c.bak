
#include "../lib/baro/baro.h"
#include "driver/i2c.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include <math.h>
#include <stdio.h>

// Define I2C Pins (Use same as your IMU)
#define I2C_MASTER_SCL_IO 22
#define I2C_MASTER_SDA_IO 21
#define I2C_MASTER_NUM 0
#define I2C_MASTER_FREQ_HZ 400000

void i2c_master_init(void) {
  i2c_config_t conf = {
      .mode = I2C_MODE_MASTER,
      .sda_io_num = I2C_MASTER_SDA_IO,
      .scl_io_num = I2C_MASTER_SCL_IO,
      .sda_pullup_en = GPIO_PULLUP_ENABLE,
      .scl_pullup_en = GPIO_PULLUP_ENABLE,
      .master.clk_speed = I2C_MASTER_FREQ_HZ,
  };
  i2c_param_config(I2C_MASTER_NUM, &conf);
  i2c_driver_install(I2C_MASTER_NUM, conf.mode, 0, 0, 0);
}

void app_main(void) {
  printf("--- BAROMETER TEST FIRMWARE ---\n");
  printf("Initializing I2C...\n");
  i2c_master_init();

  printf("Initializing Barometer...\n");
  if (baro_init() != ESP_OK) {
    printf("Barometer init FAILED! Halting.\n");
    while (1) {
      vTaskDelay(1000 / portTICK_PERIOD_MS);
    }
  }
  printf("Barometer init SUCCEEDED!\n");

  // --- CALIBRATION STEP ---
  printf("Calibrating Ground Pressure (DO NOT MOVE)...\n");
  float sum_pressure = 0.0f;
  const int calibration_samples = 100;
  for (int i = 0; i < calibration_samples; i++) {
    baro_read();
    const baro_data_t *dummy = baro_get_data();
    sum_pressure += dummy->pressure_pa;
    vTaskDelay(20 / portTICK_PERIOD_MS); // 20ms * 100 = 2 seconds
  }
  float ground_pressure = sum_pressure / calibration_samples;
  printf("Ground Pressure set: %.2f Pa\n", ground_pressure);
  vTaskDelay(1000 / portTICK_PERIOD_MS);

  // Filter State
  float filtered_pressure = ground_pressure;

  while (1) {
    baro_read();
    const baro_data_t *data = baro_get_data();

    // Low Pass Filter (Alpha = 0.98 means 98% old data, 2% new data)
    // This is EXTREMELY strong smoothing for testing.
    filtered_pressure =
        (filtered_pressure * 0.98f) + (data->pressure_pa * 0.02f);

    // Calculate Relative Altitude using FILTERED pressure
    float relative_alt =
        44330.0f * (1.0f - powf(filtered_pressure / ground_pressure, 0.1903f));

    printf("Raw: %.1f Pa | Filt: %.1f Pa | REL ALT: %.2f m\n",
           data->pressure_pa, filtered_pressure, relative_alt);

    vTaskDelay(50 / portTICK_PERIOD_MS); // Read faster (20Hz) to feed filter
  }
}
